<!DOCTYPE html><html style="height:100%;width:100%;background-color:#fff"><script src="https://segaviv.github.io/shaderhack/index.5eb58a8d.js"></script><script src="https://segaviv.github.io/shaderhack/index.09808e92.js"></script><link rel="stylesheet" href="https://segaviv.github.io/shaderhack/index.a840959d.css"><link rel="stylesheet" href="https://segaviv.github.io/shaderhack/index.928ddac0.css"><script src="https://segaviv.github.io/shaderhack/index.d1b5ebbd.js"></script><script src="https://segaviv.github.io/shaderhack/index.df5c1900.js"></script><script src="https://segaviv.github.io/shaderhack/index.7395086a.js"></script><script src="https://segaviv.github.io/shaderhack/index.fbdf1335.js"></script><script src="https://segaviv.github.io/shaderhack/index.68f774fd.js"></script><script src="https://segaviv.github.io/shaderhack/index.e2594938.js"></script><script src="https://segaviv.github.io/shaderhack/index.310a3970.js"></script><script src="https://segaviv.github.io/shaderhack/index.b99d4382.js"></script><script src="https://segaviv.github.io/shaderhack/index.3bff8f08.js"></script><link rel="stylesheet" href="https://segaviv.github.io/shaderhack/index.038972c2.css"><link rel="stylesheet" href="https://segaviv.github.io/shaderhack/index.fc8f0ef2.css"><link rel="stylesheet" href="https://segaviv.github.io/shaderhack/index.68bfdfc8.css"><script src="https://segaviv.github.io/shaderhack/index.e687c494.js"></script><link type="text/css" rel="stylesheet" href="https://segaviv.github.io/shaderhack/index.5bc897a4.css"><body style="height:100%;width:100%;justify-content:center;display:flex;overflow:hidden"> <div style="height:100%;width:95%;display:flex"> <div style="height:100%;flex-direction:column;flex:auto;justify-content:center;align-items:center;display:flex"> <canvas style="height:400px;width:400px" id="canvas" class="canvas"> </canvas> <div id="controls" style="width:100%;background-color:#f0f8ff;display:flex"> <div style="display:flex"> <span id="time" contenteditable="" style="margin-left:8px;margin-right:2px"> 0.00</span>s <span id="fps" style="margin-left:20px;margin-right:2px"> 0.0 </span>fps </div> </div> <div id="textures" style="width:100%;margin-top:8px;margin-left:8px;display:flex"> <div style="flex-direction:column;display:flex"> <img id="texture0" crossorigin style="height:80px;width:80px;background-color:#333;border:1px solid #000;border-radius:5px;margin-right:16px"> <span style="width:80px;text-align:center">tex0</span> </div> <div style="flex-direction:column;display:flex"> <img id="texture1" crossorigin style="height:80px;width:80px;background-color:#333;border:1px solid #000;border-radius:5px;margin-right:16px"> <span style="width:80px;text-align:center">tex1</span> </div> <div style="flex-direction:column;display:flex"> <img id="texture2" crossorigin style="height:80px;width:80px;background-color:#333;border:1px solid #000;border-radius:5px;margin-right:16px"> <span style="width:80px;text-align:center">tex2</span> </div> <div style="flex-direction:column;display:flex"> <img id="texture3" crossorigin style="height:80px;width:80px;background-color:#333;border:1px solid #000;border-radius:5px;margin-right:16px"> <span style="width:80px;text-align:center">tex3</span> </div> </div> </div> <div id="code" style="height:90%;opacity:.97;align-items:center;margin-left:20px;display:flex;top:5%"> <div id="funcs" style="flex-direction:column;align-self:start;display:flex"> <span id="togglefuncs" class="collapsible">Builtins</span> <div style="display:block" class="content"> <textarea id="funcstext">
          </textarea> </div> </div> <textarea id="textarea" style="height:100%">
      </textarea> </div> </div> <div style="display:block;position:absolute;bottom:0;left:10px;right:10px"> <input id="command" style="width:100%;display:none"> </div> <dialog id="help_dialog" style="background-color:#b8b8b8e0;border-radius:5px"> <div style="flex-direction:column;display:flex"> <h4 style="align-self:center">Help (Esc to close)</h4> <p> This is a mini hacked version of <a href="https://www.shadertoy.com" target="_blank">Shadertoy</a>.<br> It has some tricks to make it easier to fine tune variables, and plenty of shortcuts. </p> <table style="width:100%;background-color:#999"> <tr> <th colspan="4" style="color:#fff;background-color:#333"> Shortcuts</th> </tr> <tr style="background-color:#777"> <td>⌘/Alt/Ctrl + Enter</td> <td>Compile</td> <td>⌘/Ctrl + 1</td> <td>Show gui</td> </tr> <tr> <td>⌥/Alt/Ctrl + F</td> <td>Toggle fullscreen</td> <td>⌘/Ctrl + 2</td> <td>Show controls</td> </tr> <tr style="background-color:#777"> <td>Drag image to tex</td> <td>Load texture</td> <td>⌘/Ctrl + 3</td> <td>Show/hide textures</td> </tr> <tr> <td>⌥/Alt + ↑ </td> <td>Start/Stop time</td> <td>⌥/Alt + ↓ </td> <td>Reset time</td> </tr> <tr style="background-color:#777"> <td>~</td> <td>Show/hide editor</td> <td>Ctrl + ~</td> <td>Command prompt</td> </tr> <tr> <td>⌘/Ctrl + S</td> <td>Quick save</td> <td>⌘/Ctrl + O</td> <td>Quick load</td> </tr> <tr style="background-color:#777"> <td colspan="2">(Select val) ⌘/Ctrl + E</td> <td colspan="2">Extract uniform</td> </tr> <tr> <td colspan="2">(Select uniform) ⌘/Ctrl + E</td> <td colspan="2">Replace with value</td> </tr> <tr style="background-color:#777"> <td colspan="2">⌘/Alt + canvas click + mouse move</td> <td colspan="2">Resize canvas</td> </tr> <tr> <td colspan="2">canvas click + mouse move</td> <td colspan="2">Control mouse variable</td> </tr> <tr style="background-color:#777"> <td colspan="2">shift + mouse move</td> <td colspan="2">Make it move faster</td> </tr> </table> </div> </dialog> </body><script>const autoUniformRegex=/\/\*\s*([a-z\d]+)\s*\*\/\s*([a-zA-Z\d\_]+)/g,assignmentRegex=/([a-zA-Z\d\_\.]+)\s*\=/g,vec2Vals=/\((\d*\.?\d*)\s*\,\s*(\d*\.?\d*)\)/g,vec3Vals=/\((\d*\.?\d*)\s*\,\s*(\d*\.?\d*)\s*,\s*(\d*\.?\d*)\)/g,vec4Vals=/\((\d*\.?\d*)\s*\,\s*(\d*\.?\d*)\s*,\s*(\d*\.?\d*)\s*,\s*(\d*\.?\d*)\)/g,codeElem=document.getElementById("code"),dialogElement=document.getElementById("help_dialog"),commandElem=document.getElementById("command"),timeElem=document.getElementById("time"),fpsElem=document.getElementById("fps");let lastFpsTimestamp,framesCount;const FLOAT_PRECISION="#version 300 es\n   precision mediump float;\n    out vec4 fragColor;\n    ",FRAG_SHADER_PREFIX="// Shadertoy compatibility\n#define iResolution res\n#define iFrame 0\n#define HW_PERFORMANCE 0\n#define iTime time\n#define iMouse mouse\n\n// Textures and their resolutions.\nuniform sampler2D tex0;\nuniform sampler2D tex1;\nuniform sampler2D tex2;\nuniform sampler2D tex3;\nuniform vec2 res0;\nuniform vec2 res1;\nuniform vec2 res2;\nuniform vec2 res3;\n\n// Screen resolution.\nuniform vec2 res;\n// Elapsed time in seconds.\nuniform float time;\n// Mouse coords (x, y, wheel).\nuniform vec3 mouse;\n",FRAG_SHARDER_SUFFIX="\n  void main() {\n      vec4 temp = vec4(0.0);\n      mainImage(temp, gl_FragCoord.xy);\n      fragColor = vec4(temp.xyz, 1.0);\n    }\n  ",magicFuncs=new Map,vsSource="#version 300 es\n in vec4 aVertexPosition; void main(){gl_Position = aVertexPosition;}",fsSource="\nvec2 map2(vec3 p) {\n  float boxDist = sdBox(p, vec3(0.1, 0.3, 0.1));\n  float sphereDist = sdSphere(p - vec3(0.4, 0.1, 0.2), .1);\n  return boxDist < sphereDist?\n         vec2(boxDist, 1.0) : vec2(sphereDist, 2.0);\n}\n\nvoid mainImage(out vec4 color, in vec2 pix) {\n  color = vec4(1.);\n  vec2 p = (pix * 2.0 - res) / res.y;\n  vec3 ro, rd;\n  orbitMouseCam(p, vec3(0.), ro, rd);\n  // March and apply color if hit.\n  float t = raymarch(ro, rd, 0., 100.);\n  if (t >= 0.) {\n    color = colorize(ro + t * rd, rd);\n  }\n  // Apply post processing effects.\n  color = gammaCorrect(color);\n  color *= vignette(pix, 0.2);\n}";var _transitions=[];const AUTO_COMPILE_DELAY_MS=250,canvas=document.getElementById("canvas"),controls=document.getElementById("controls"),texturesElem=document.getElementById("textures"),texture0=document.getElementById("texture0"),texture1=document.getElementById("texture1"),texture2=document.getElementById("texture2"),texture3=document.getElementById("texture3"),allTextures=[texture0,texture1,texture2,texture3],gl=canvas.getContext("webgl2"),input=document.getElementById("textarea");let editor,funcEditor;input.value=fsSource;const textures=[null,null,null,null];var autoCompile=!1;let gShaderProgram=null,gBuffers=null,gProgramInfo=null,triggerCompilerTimeout=null,compilePromise=null,gUniforms=new Map,uniformsGui={};const guiControllers=new Map;let configGui={aspect_ratio:1.777,width:400,animate:!1,builtin_funcs:!0,endlessMouse:!0,clearStorage:()=>localStorage.clear(),quickSave:()=>{localStorage.setItem("code",editor.getValue()),SnackBar({status:"success",message:"Saved + Sharing URL copied to clipboard",timeout:3e3})},quickLoad:()=>{const e=localStorage.getItem("code");e?(editor.setValue(e),SnackBar({status:"success",message:"Loaded",timeout:1e3}),compile()):SnackBar({status:"error",message:"No saved code exists",timeout:1e3})}},selectedElem,lastMousePos,animateController,lastTimestamp=null,mouse={x:0,y:0,z:0},mouseControllers=[],sizeControllers=[],gui=new dat.GUI;function initBuffers(e){const t=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,t);return e.bufferData(e.ARRAY_BUFFER,new Float32Array([1,1,-1,1,1,-1,-1,-1]),e.STATIC_DRAW),{position:t}}function createTexture(e){const t=gl.createTexture();return gl.bindTexture(gl.TEXTURE_2D,t),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!0),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,e),t}function initShaderProgram(e,t,n,o){const a=loadShader(e,e.VERTEX_SHADER,t,o);if(null==a)return null;const r=loadShader(e,e.FRAGMENT_SHADER,n,o);if(null==r)return e.deleteShader(a),null;const i=e.createProgram();return e.attachShader(i,a),e.attachShader(i,r),e.linkProgram(i),e.deleteShader(a),e.deleteShader(r),e.getProgramParameter(i,e.LINK_STATUS)?i:(console.log("Unable to initialize the shader program: "+e.getProgramInfoLog(i)),e.deleteProgram(i),null)}function unique(e){return[...new Set(e)]}function reportErrorCompilingShader(e,t){unique([...e.matchAll(/0\:\d+/g)].map((e=>e[0]))).forEach((n=>{const o=n.split(":"),a=parseInt(o[1])-t+1;e=e.replaceAll(n,`${o[0]}:${a}`),editor.addLineClass(a-1,"background","redBackground")})),e=e.replaceAll("\n","<br>"),SnackBar({message:e,status:"error",timeout:!1})}function loadShader(e,t,n,o){const a=e.createShader(t);return e.shaderSource(a,n),e.compileShader(a),e.getShaderParameter(a,e.COMPILE_STATUS)?a:(reportErrorCompilingShader(e.getShaderInfoLog(a),o),e.deleteShader(a),null)}function drawScene(e,t,n,o){t.viewport(0,0,t.canvas.width,t.canvas.height),t.clearColor(0,0,0,1),t.clear(t.COLOR_BUFFER_BIT);{const e=2,a=t.FLOAT,r=!1,i=0,s=0;t.bindBuffer(t.ARRAY_BUFFER,o.position),t.vertexAttribPointer(n.attribLocations.vertexPosition,e,a,r,i,s),t.enableVertexAttribArray(n.attribLocations.vertexPosition)}t.useProgram(n.program),t.uniform2f(n.uniformLocations.res,e.width,e.height),t.uniform3f(n.uniformLocations.mouse,mouse.x,mouse.y,mouse.z),t.uniform1f(n.uniformLocations.time,parseFloat(timeElem.innerText)),updateTextures(),updateUniformValues();{const e=0,n=4;t.drawArrays(t.TRIANGLE_STRIP,e,n)}}function initializeMagicFuncs(){magicFuncs.set("sdCircle",{code:"float sdCircle(vec2 p, float r) {\n  return length(p) - r;\n}"}),magicFuncs.set("sdBox",{code:"float sdBox(vec2 p, vec2 b) {\n  vec2 d = abs(p)-b;\n  return length(max(d,0.0)) + min(max(d.x,d.y),0.0);\n}\nfloat sdBox(vec3 p, vec3 b) {\n  vec3 q = abs(p) - b;\n  return length(max(q,0.0)) + min(max(q.x,max(q.y,q.z)),0.0);\n}"}),magicFuncs.set("sdEqTriangle",{code:"float sdEqTriangle( in vec2 p ) {\n  const float k = sqrt(3.0);\n  p.x = abs(p.x) - 1.0;\n  p.y = p.y + 1.0/k;\n  if( p.x+k*p.y>0.0 ) p = vec2(p.x-k*p.y,-k*p.x-p.y)/2.0;\n  p.x -= clamp( p.x, -2.0, 0.0 );\n  return -length(p)*sign(p.y);\n}"}),magicFuncs.set("sdTriangle",{code:"float sdTriangle(vec2 p, vec2 p0, vec2 p1, vec2 p2 ) {\n    vec2 e0 = p1-p0, e1 = p2-p1, e2 = p0-p2;\n    vec2 v0 = p -p0, v1 = p -p1, v2 = p -p2;\n    vec2 pq0 = v0 - e0*clamp( dot(v0,e0)/dot(e0,e0), 0.0, 1.0 );\n    vec2 pq1 = v1 - e1*clamp( dot(v1,e1)/dot(e1,e1), 0.0, 1.0 );\n    vec2 pq2 = v2 - e2*clamp( dot(v2,e2)/dot(e2,e2), 0.0, 1.0 );\n    float s = sign( e0.x*e2.y - e0.y*e2.x );\n    vec2 d = min(min(vec2(dot(pq0,pq0), s*(v0.x*e0.y-v0.y*e0.x)),\n                     vec2(dot(pq1,pq1), s*(v1.x*e1.y-v1.y*e1.x))),\n                     vec2(dot(pq2,pq2), s*(v2.x*e2.y-v2.y*e2.x)));\n    return -sqrt(d.x)*sign(d.y);\n}"}),magicFuncs.set("smin",{code:"float smin(float a, float b, float k) {\n  float h = max( k-abs(a-b), 0.0 );\n  return min( a, b ) - h*h/k*0.25;\n}"}),magicFuncs.set("smax",{deps:["smin"],code:"float smin(float a, float b, float k);\nfloat smax(float a, float b, float k) {\n  return -smin(-a, -b, k);\n}"}),magicFuncs.set("sdSegment",{code:"float sdSegment( in vec2 p, in vec2 a, in vec2 b ) {\n  vec2 pa = p-a, ba = b-a;\n  float h = clamp( dot(pa,ba)/dot(ba,ba), 0.0, 1.0 );\n  return length( pa - ba*h );\n}"}),magicFuncs.set("sdSphere",{code:"float sdSphere(in vec3 p, float r) {\n  return length(p) - r;\n}"}),magicFuncs.set("hash",{code:"float hash(float p) {\n  return fract(25625.66*sin(683.12*p));\n}\nfloat hash(vec2 p) {\n  return fract(14524.12*sin(123.34*p.x+55.1234*p.y));\n}\nfloat hash(vec3 p) {\n  return fract(87625.123*sin(52.865*p.x+124.63*p.y+672.12*p.z));\n}"}),magicFuncs.set("hash2",{code:"vec2 hash2(float p) {\n  return vec2(fract(82653.124*sin(473.24*p)),\n              fract(14253.64*sin(2561.3*p)));\n}\nvec2 hash2(vec2 p) {\n  return vec2(fract(14524.12*sin(123.34*p.x+55.1234*p.y)),\n              fract(51364.16*sin(352.21*p.x+1413.34*p.y)));\n}\nvec2 hash2(vec3 p) {\n  return vec2(fract(65234.23*sin(542.2*p.x+124.3*p.y+643.*p.z)),\n              fract(5251.4*sin(423.3*p.x+111.23*p.y+125.3*p.x)));\n}"}),magicFuncs.set("hash3",{code:"vec3 hash3(float p) {\n  return vec3(fract(14524.12*sin(123.34*p)),\n              fract(51364.16*sin(352.21*p)),\n              fract(96234.55*sin(56.13*p)));\n}\nvec3 hash3(vec2 p) {\n  return vec3(fract(14524.12*sin(123.34*p.x+55.1234*p.y)),\n              fract(51364.16*sin(352.21*p.x+1413.34*p.y)),\n              fract(96234.55*sin(56.13*p.x+235.142*p.y)));\n}"}),magicFuncs.set("vnoise",{deps:["hash"],code:"float hash(vec2 p);\nfloat vnoise(vec2 p){\n  vec2 i = floor(p);\n  vec2 f = fract(p);\n  f = f*f*(3.0-2.0*f);\n\n  return mix(\n      mix(hash(i), hash(i + vec2(1.0,0.0)),f.x),\n      mix(hash(i + vec2(0.0,1.0)), hash(i + vec2(1.0,1.0)), f.x),\n      f.y);\n}"}),magicFuncs.set("fbm",{deps:["vnoise"],code:"float vnoise(vec2 p);\nfloat fbm(vec2 p) {\n  float res = 0.;\n  float amp = 0.5;\n  for (int i = 0; i < 8; i++) {\n    res += amp * vnoise(p);\n    amp *= 0.5;\n    p *= 2.;\n  }\n  return res;\n}"}),magicFuncs.set("map2",{code:"vec2 map2(vec3 p) {\n  return vec2(1.0, 1.0);\n}\n"}),magicFuncs.set("map",{deps:["map2"],code:"vec2 map2(vec3 p);\nfloat map(vec3 p) {\n  return map2(p).x;\n}\n"}),magicFuncs.set("sdfNormal",{deps:["map"],code:"float map(vec3 p);\nvec2 map2(vec3 p);\nvec3 sdfNormal(vec3 pos, float eps) {\n  vec2 e = vec2(0.5773,-0.5773);\n  return normalize(\n      e.xyy*map(pos + e.xyy*eps) + \n\t\t\te.yyx*map(pos + e.yyx*eps) + \n\t\t\te.yxy*map(pos + e.yxy*eps) + \n\t\t\te.xxx*map(pos + e.xxx*eps));\n}"}),magicFuncs.set("colorize",{deps:["calcAO","map2","chooseColor","mainLight","backLight","sdfNormal"],code:"vec3 mainLight(vec3 p, vec3 n, vec3 rd);\nvec3 backLight(vec3 p, vec3 n);\nfloat calcAO(vec3 pos, vec3 nor);\nvec3 sdfNormal(vec3 pos, float eps);\nvec2 map2(vec3 p);\nvec3 chooseColor(vec3 p, vec3 rd, vec3 n, float id);\nvec4 colorize(vec3 p, vec3 rd) {\n  vec3 col = vec3(0.);\n  vec3 n = sdfNormal(p, 1e-4);\n  // Material color.\n  vec3 mat = chooseColor(p, rd, n, map2(p).y);\n\n  // Apply main light.\n  col += mat * mainLight(p, n, rd) * /*float*/ main_light_intensity;\n\n  // Fake ambient occlusion.\n  float ao = calcAO(p, n);\n\n  // Apply back light.\n  col += ao * mat * backLight(p, n) * /*float*/ back_light_intensity;\n  return vec4(col, 1.0);\n}\n"}),magicFuncs.set("rotate",{code:"vec3 rotate(vec3 p, vec3 axis, float angle) {\n    axis = normalize(axis);\n    float s = sin(angle);\n    float c = cos(angle);\n    float oc = 1.0 - c;\n    \n    return (mat4(oc * axis.x * axis.x + c,           oc * axis.x * axis.y - axis.z * s,  oc * axis.z * axis.x + axis.y * s,  0.0,\n                oc * axis.x * axis.y + axis.z * s,  oc * axis.y * axis.y + c,           oc * axis.y * axis.z - axis.x * s,  0.0,\n                oc * axis.z * axis.x - axis.y * s,  oc * axis.y * axis.z + axis.x * s,  oc * axis.z * axis.z + c,           0.0,\n                0.0,                                0.0,                                0.0,                                1.0) \n            * vec4(p, 1.0)).xyz;\n}"}),magicFuncs.set("chooseColor",{deps:["hash3","map2"],code:"vec3 hash3(float p);\nvec2 map2(vec3 p);\nvec3 chooseColor(vec3 p, vec3 rd, vec3 n, float id) {\n  return normalize(hash3(map2(p).y)) * 0.3;\n}\n"}),magicFuncs.set("raymarch",{deps:["map2"],code:"vec2 map2(vec3 p);\nfloat raymarch(vec3 ro, vec3 rd, float tmin, float tmax) {\n  float t = tmin;\n  int i = 0;\n  for(; i<80; i++ ) {\n    float dist = map2(ro + t * rd).x;\n\n    // Break if we're close enough to the surface.\n    if(abs(dist)<(0.15*t/res.x)) break;\n\n    t += dist * 0.6;\n    // Break if we exceeded tmax.\n    if( t>tmax ) return -1.0;\n  }\n  return t;\n}"}),magicFuncs.set("calcShadow",{deps:["map"],code:"float map(vec3 p);\nfloat calcShadow(vec3 ro, vec3 rd, float tmin, float tmax) {\n  float t = tmin;\n  float shadow = 1.0;\n  for(int i = 0; i<100; i++ ) {\n    float dist = map2(ro + t * rd).x;\n    t += clamp(dist, 0.02, 0.3);\n    shadow = min(shadow, dist / t);\n    // Break if we're close enough to the surface.\n    if(shadow<1e-3 || t > tmax) break;\n  }\n  return clamp(shadow, 0., 1.);\n}"}),magicFuncs.set("orbitMouseCam",{deps:["rayDir"],code:"vec3 rayDir(vec2 p, vec3 lookat, vec3 ro);\nvoid orbitMouseCam(vec2 p, vec3 lookat, out vec3 ro, out vec3 rd) {\n  float d = 1. + mouse.z / res.x / 2.;\n  ro = d * vec3(sin(2.*mouse.x / res.x), 0, cos(2.*mouse.x / res.x));\n  ro.y = 2.*mouse.y / res.y;\n\n  rd = rayDir(p, lookat, ro);\n}"}),magicFuncs.set("rayDir",{code:"vec3 rayDir(vec2 p, vec3 lookat, vec3 ro) {\n  vec3 up = vec3(0., 1., 0.);\n  vec3 cz = normalize(lookat - ro);\n  vec3 lr = cross(cz, up);\n  vec3 ud = cross(lr, cz);\n\n  return normalize( p.x*lr + p.y*ud + 2.5*cz );\n}"}),magicFuncs.set("mainLight",{deps:["calcShadow"],code:"float calcShadow(vec3 ro, vec3 rd, float tmin, float tmax);\nvec3 mainLight(vec3 p, vec3 n, vec3 rd) {\n  vec3 ld = normalize(/*vec3*/main_light_dir);\n  // Diffuse.\n  float d = clamp(0.5+0.5*dot(n, ld), 0., 1.);\n  float sh = calcShadow(p, ld, 0.02, 50.);\n  vec3 col = sh * d * /*col*/ main_light_color;\n\n  // Specular.\n  vec3 hal = normalize(ld-rd);\n  float s = clamp(dot(n,hal), 0.0, 1.0);\n  float fre = clamp(dot(-rd,ld), 0.0, 1.0);\n  col += pow(s, 8.)*d*sh*pow(fre,5.0);\n  return col;\n}"}),magicFuncs.set("backLight",{code:"vec3 backLight(vec3 p, vec3 n) {\n  float d = clamp(dot(n, - normalize(/*vec3*/main_light_dir)), 0., 1.);\n  return d * /*col*/ back_light_color;\n}"}),magicFuncs.set("min2",{code:"vec2 min2(vec2 a, vec2 b) {\n  return a.x < b.x? a : b;\n}"}),magicFuncs.set("vignette",{code:"float vignette(vec2 pix, float intensity) {\n  vec2 p = pix / res;\n  return pow(16.0*p.x*p.y*(1.0-p.x)*(1.0-p.y), intensity);\n}"}),magicFuncs.set("gammaCorrect",{code:"vec4 gammaCorrect(vec4 color) {\n  return vec4(pow(color.xyz, vec3(0.4545)), 1.0);\n}"}),magicFuncs.set("calcAO",{deps:["map"],code:"float map(vec3 p);\nfloat calcAO(vec3 pos, vec3 nor) {\n\tfloat totao = 0.0;\n  float sc = 1.0;\n  for(int i=0; i<5; i++ ) {\n      float ed = 0.01 + 0.05*float(i);\n      vec3 aopos =  nor * ed + pos;\n      float dd = map2( aopos ).x;\n      totao += (ed - dd)*sc;\n      sc *= .75;\n  }\n  return clamp( 1.0 - 4.0*totao, 0.0, 1.0 );\n}\n"})}function initFuncHelp(){let e=FRAG_SHADER_PREFIX+"\n";[...magicFuncs.keys()].forEach((t=>e+=magicFuncs.get(t).code+"\n\n")),funcEditor=CodeMirror.fromTextArea(document.getElementById("funcstext"),{mode:"x-shader/x-fragment",lineNumbers:!0,readOnly:!0,lineWrapping:!0,matchBrackets:!0,foldGutter:!0,gutters:["CodeMirror-linenumbers","CodeMirror-foldgutter"],indentUnit:2}),funcEditor.setValue(e),CodeMirror.commands.foldAll(funcEditor),[...document.getElementsByClassName("collapsible")].forEach((e=>{e.addEventListener("click",(function(){this.classList.toggle("active");var e=this.nextElementSibling;"block"===e.style.display?e.style.display="none":e.style.display="block"}))})),[...document.getElementsByClassName("content")].forEach((e=>e.style.display="none"))}async function init(){initializeMagicFuncs(),initFuncHelp();const e=getUrlParam("code");e&&(input.value=e),configGui.width=canvas.parentElement.parentElement.clientWidth/2,editor=CodeMirror.fromTextArea(document.getElementById("textarea"),{mode:"x-shader/x-fragment",lineNumbers:!0,lineWrapping:!0,matchBrackets:!0,foldGutter:!0,gutters:["CodeMirror-linenumbers","CodeMirror-foldgutter"],extraKeys:{"Ctrl-Space":"autocomplete","Ctrl-Q":function(e){e.foldCode(e.getCursor())}},indentUnit:2}),editor.getWrapperElement().style.height="100%",editor.on("change",(()=>{autoCompile&&(triggerCompilerTimeout&&clearTimeout(triggerCompilerTimeout),setTimeout((()=>{compilePromise=compile()}),AUTO_COMPILE_DELAY_MS))})),gBuffers=initBuffers(gl),compilePromise=compile(),await compilePromise,resizeCanvas(),gUniforms.get("main_light_color").value=[.8,.8,.8],gUniforms.get("back_light_color").value=[.9,.3,.3],gUniforms.get("main_light_dir").value=[2.55,1,1.6],gUniforms.get("main_light_intensity").value=7.94,gUniforms.get("back_light_intensity").value=.5,onUniformUpdate(),createUniformGui(),localStorage.getItem("help_shown")||SnackBar({message:"Press Alt/Ctrl + H for help",timeout:5e3})}function defaultValueForType(e){switch(e){case"bool":return!1;case"int":case"float":return 0;case"vec2":return[0,0];case"vec3":case"col":return[0,0,0];case"vec4":return[0,0,0,0]}return""}function extractUniforms(e){const t=[...e.matchAll(autoUniformRegex)],n=new Set(t.map((e=>e[2])));let o=[];[...gUniforms.keys()].filter((e=>!n.has(e))).forEach((e=>{o.push(gUniforms.get(e)),gUniforms.delete(e)})),t.forEach((e=>{gUniforms.has(e[2])&&isSameType(gUniforms.get(e[2]).type,e[1])?isSameType(gUniforms.get(e[2]).type,e[1])&&(gUniforms.get(e[2]).type=e[1]):gUniforms.set(e[2],{type:e[1],value:1==o.length&&isSameType(o[0].type,e[1])?o[0].value:defaultValueForType(e[1])})})),createUniformGui()}function isSameType(e,t){return("col"==e?"vec3":e)==("col"==t?"vec3":t)}function getUniformString(){let e="";return gUniforms.forEach(((t,n)=>{const o="col"==t.type?"vec3":t.type;e+=`uniform ${o} ${n};`})),e}function prevWord(e,t){for(;t>=0&&e[t].match(/\s/);)t--;let n=t;for(;n>=0&&e[n].match(/[a-z\d]/);)n--;return e.substr(n+1,t-n)}function addMagicFuncs(e){if(!configGui.builtin_funcs)return"";const t=/float|int|vec2|vec3|vec4/,n=new RegExp([...magicFuncs.keys()].map((e=>`${e}\\(`)).join("|"),"g"),o=[...e.matchAll(n)],a=new Set,r=new Set;o.forEach((n=>{const o=n[0].substr(0,n[0].length-1);prevWord(e,n.index-1).match(t)?a.add(o):a.has(o)||r.add(o)}));let i="";const s=e=>{if(a.has(e))return;const t=magicFuncs.get(e);t.deps?.forEach((e=>s(e))),i+=`${t.code}\n`,a.add(e)};return r.forEach((e=>s(e))),i}function resizeCanvas(){document.fullscreenElement||(canvas.classList.remove("floatingViewer"),canvas.style.width=`${configGui.width}px`,canvas.style.height=configGui.width/configGui.aspect_ratio+"px");const e=window.devicePixelRatio,t=Math.round(canvas.clientWidth*e),n=Math.round(canvas.clientHeight*e);canvas.width==t&&canvas.height==n||(canvas.width=t,canvas.height=n,gl.viewport(0,0,gl.canvas.width,gl.canvas.height),controls.style.width=`${canvas.clientWidth}px`,texturesElem.style.width=`${canvas.clientWidth}px`,onUniformUpdate(),updateCodeEditorType())}function createReconfigGui(){animateController=gui.add(configGui,"animate").onChange((()=>{handleAnimateChange()})),gui.add(window,"autoCompile"),gui.add(configGui,"builtin_funcs");const e=gui.addFolder("storage");e.add(configGui,"clearStorage"),e.add(configGui,"quickSave"),e.add(configGui,"quickLoad");const t=gui.addFolder("Sizing");sizeControllers=[],sizeControllers.push(t.add(configGui,"aspect_ratio",void 0,void 0,.01).onChange((()=>resizeCanvas()))),sizeControllers.push(t.add(configGui,"width",200,window.innerWidth).onChange((()=>resizeCanvas())));const n=gui.addFolder("Mouse");n.add(configGui,"endlessMouse"),mouseControllers=[],mouseControllers.push(n.add(mouse,"x",void 0,void 0,5).onChange((()=>onUniformUpdate()))),mouseControllers.push(n.add(mouse,"y",void 0,void 0,5).onChange((()=>onUniformUpdate()))),mouseControllers.push(n.add(mouse,"z",void 0,void 0,5).onChange((()=>onUniformUpdate())))}function createUniformGui(){gui.destroy(),guiControllers.clear(),uniformsGui={},gui=new dat.GUI,createReconfigGui(),gui.hide(),gUniforms.forEach(((e,t)=>{switch(e.type){case"bool":return uniformsGui[t]=e.value,void guiControllers.set(t,gui.add(uniformsGui,t).onChange((()=>{e.value=uniformsGui[t],onUniformUpdate()})));case"int":case"float":return uniformsGui[t]=e.value,void guiControllers.set(t,gui.add(uniformsGui,t,void 0,void 0,.01).onChange((()=>{e.value=uniformsGui[t],onUniformUpdate()})));case"vec2":case"vec3":case"vec4":return uniformsGui[`${t}.x`]=e.value[0],guiControllers.set(t,gui.add(uniformsGui,`${t}.x`,void 0,void 0,.01).onChange((()=>{e.value[0]=uniformsGui[`${t}.x`],onUniformUpdate()}))),uniformsGui[`${t}.y`]=e.value[1],guiControllers.set(t,gui.add(uniformsGui,`${t}.y`,void 0,void 0,.01).onChange((()=>{e.value[1]=uniformsGui[`${t}.y`],onUniformUpdate()}))),"vec2"!=e.type&&(uniformsGui[`${t}.z`]=e.value[2],guiControllers.set(t,gui.add(uniformsGui,`${t}.z`,void 0,void 0,.01).onChange((()=>{e.value[2]=uniformsGui[`${t}.z`],onUniformUpdate()})))),void("vec4"==e.type&&(uniformsGui[`${t}.w`]=e.value[3],guiControllers.set(t,gui.add(uniformsGui,`${t}.w`,void 0,void 0,.01).onChange((()=>{e.value[3]=uniformsGui[`${t}.w`],onUniformUpdate()})))));case"col":uniformsGui[t]=e.value.map((e=>255*e)),guiControllers.set(t,gui.addColor(uniformsGui,t).onChange((()=>{e.value=uniformsGui[t].map((e=>e/255)),onUniformUpdate()})))}}))}function updateTextures(){textures[0]&&(gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,textures[0]),gl.uniform1i(gProgramInfo.uniformLocations.tex0,0),gl.uniform2f(gProgramInfo.uniformLocations.res0,texture0.naturalWidth,texture0.naturalHeight)),textures[1]&&(gl.activeTexture(gl.TEXTURE1),gl.bindTexture(gl.TEXTURE_2D,textures[1]),gl.uniform1i(gProgramInfo.uniformLocations.tex1,1),gl.uniform2f(gProgramInfo.uniformLocations.res1,texture1.naturalWidth,texture1.naturalHeight)),textures[2]&&(gl.activeTexture(gl.TEXTURE2),gl.bindTexture(gl.TEXTURE_2D,textures[2]),gl.uniform1i(gProgramInfo.uniformLocations.tex2,2),gl.uniform2f(gProgramInfo.uniformLocations.res2,texture2.naturalWidth,texture2.naturalHeight)),textures[3]&&(gl.activeTexture(gl.TEXTURE3),gl.bindTexture(gl.TEXTURE_2D,textures[3]),gl.uniform1i(gProgramInfo.uniformLocations.tex3,3),gl.uniform2f(gProgramInfo.uniformLocations.res3,texture3.naturalWidth,texture3.naturalHeight))}function updateUniformValues(){gUniforms.forEach(((e,t)=>{const n=gl.getUniformLocation(gShaderProgram,t);switch(e.type){case"bool":gl.uniform1i(n,e.value);case"int":return void gl.uniform1i(n,e.value);case"float":return void gl.uniform1f(n,e.value);case"vec2":return void gl.uniform2fv(n,e.value);case"vec3":case"col":return void gl.uniform3fv(n,e.value);case"vec4":return void gl.uniform4fv(n,e.value)}}))}function onUniformUpdate(){drawScene(canvas,gl,gProgramInfo,gBuffers)}function clearSnackbars(){[...document.getElementsByClassName("js-snackbar-container")].forEach((e=>{e.getElementsByClassName("js-snackbar--danger").length>0&&e.remove()})),[...Array(editor.lineCount()).keys()].forEach((e=>editor.removeLineClass(e,"background")))}async function compile(){const e=new Promise(((e,t)=>{const n=editor.getValue(),o=addMagicFuncs(n);clearSnackbars(),extractUniforms(o+n);const a=FLOAT_PRECISION+FRAG_SHADER_PREFIX+getUniformString()+o,r=a.split("\n").length,i=initShaderProgram(gl,vsSource,a+n+FRAG_SHARDER_SUFFIX,r);i?(SnackBar({status:"success",message:"Compiled successfully",timeout:1e3}),e(i)):t("failed")}));return e.then((e=>{compilePromise=null,gl.deleteProgram(gShaderProgram),gShaderProgram=e,gProgramInfo={program:gShaderProgram,attribLocations:{vertexPosition:gl.getAttribLocation(gShaderProgram,"aVertexPosition")},uniformLocations:{res:gl.getUniformLocation(gShaderProgram,"res"),res0:gl.getUniformLocation(gShaderProgram,"res0"),res1:gl.getUniformLocation(gShaderProgram,"res1"),res2:gl.getUniformLocation(gShaderProgram,"res2"),res3:gl.getUniformLocation(gShaderProgram,"res3"),time:gl.getUniformLocation(gShaderProgram,"time"),mouse:gl.getUniformLocation(gShaderProgram,"mouse"),tex0:gl.getUniformLocation(gShaderProgram,"tex0"),tex1:gl.getUniformLocation(gShaderProgram,"tex1"),tex2:gl.getUniformLocation(gShaderProgram,"tex2"),tex3:gl.getUniformLocation(gShaderProgram,"tex3")}},drawScene(canvas,gl,gProgramInfo,gBuffers)}))}function updateCodeEditorType(){canvas.clientWidth>=.6*canvas.parentElement.parentElement.clientWidth?codeElem.classList.add("floatingEditor"):codeElem.classList.remove("floatingEditor")}function getUrlWithoutParams(){return location.protocol+"//"+location.host+location.pathname}function getUrlParam(e){return new URLSearchParams(window.location.search).get(e)}function insertUniform(e){const t=gUniforms.get(e),n=`/*${t.type}*/${e}`,o=editor.getSearchCursor(n);if(!o.find())return;let a=t.value;Array.isArray(a)?a=`vec${a.length}(${a.map((e=>e.toFixed(3))).join(",")})`:"float"==t.type&&String(a).indexOf(".")<0&&(a=a.toFixed(1)),o.replace(String(a),n),compile()}function extractUniform(e){const t=addVariableWithType(e);editor.replaceSelection(`/*${e.type}*/${t}`),compile()}function addVariableWithType(e){for(let t=0;t<100;t++){const n=`${e.type}_var_${t}`;if(!gUniforms.has(n))return gUniforms.set(n,{type:e.type,value:e.val}),n}return""}function inferVariableTypeAndValue(e){let t=[],n="";return(e=e.trim()).startsWith("vec2")?(t=[...e.matchAll(vec2Vals)][0]?.slice(1)?.map((e=>parseFloat(e))),n="vec2"):e.startsWith("vec3")?(t=[...e.matchAll(vec3Vals)][0]?.slice(1)?.map((e=>parseFloat(e))),n="vec3"):e.startsWith("vec4")?(t=[...e.matchAll(vec4Vals)][0]?.slice(1)?.map((e=>parseFloat(e))),n="vec4"):e.indexOf(".")>=0?(t=parseFloat(e),n="float"):"false"==e||"true"==e?(t="true"==e,n="bool"):(t=parseInt(e),n="int"),t?{type:n,val:t}:{type:""}}function handleAnimateChange(){configGui.animate&&requestAnimationFrame(animate)}function animate(e){if(lastTimestamp){const t=e-lastTimestamp;let n=parseFloat(timeElem.innerText);if(n+=t/1e3,timeElem.innerText=n.toFixed(3),e-lastFpsTimestamp>700){const t=framesCount/(e-lastFpsTimestamp)*1e3;fpsElem.innerText=t.toFixed(2),framesCount=0,lastFpsTimestamp=e}}onUniformUpdate(),framesCount++,configGui.animate?(lastTimestamp=e,lastFpsTimestamp||(lastFpsTimestamp=e,framesCount=1),requestAnimationFrame(animate)):(lastTimestamp=null,lastFpsTimestamp=null)}function mix(e,t,n){return Array.isArray(e)?e.map(((e,o)=>e*(1-n)+t[o]*n)):e*(1-n)+t*n}function linstep(e,t,n){return Math.max(0,Math.min(1,(n-e)/(t-e)))}function smoothstep(e,t,n){const o=linstep(e,t,n);return o*o*(3-2*o)}function expEaseOut(e,t,n){const o=linstep(e,t,n);return 1===o?1:1-Math.pow(2,-10*o)}function interpolate(e,t,n=1e3,o=expEaseOut){let a,r,i=gUniforms.get(e).value;Array.isArray(i)&&(i=[...i]);const s=c=>{if(void 0===a&&(a=c,r=a+n),c<r){let n=mix(i,t,o(a,r,c));gUniforms.get(e).value=n,requestAnimationFrame(s)}else gUniforms.get(e).value=t,createUniformGui();onUniformUpdate()};requestAnimationFrame(s)}init(),timeElem.addEventListener("mousedown",(e=>{selectedElem=timeElem,timeElem.requestPointerLock()})),canvas.addEventListener("mousedown",(e=>{selectedElem=canvas,configGui.endlessMouse&&canvas.requestPointerLock()})),canvas.addEventListener("mousemove",(e=>{if(selectedElem==canvas){if(configGui.endlessMouse)if(e.metaKey||e.altKey){configGui.width+=e.movementX*(e.shiftKey?10:1);const t=canvas.clientHeight-e.movementY*(e.shiftKey?10:1);configGui.aspect_ratio=configGui.width/t,sizeControllers.forEach((e=>e.updateDisplay())),resizeCanvas()}else mouse.x-=e.movementX*(e.shiftKey?10:1),mouse.y+=e.movementY*(e.shiftKey?10:1),mouseControllers.forEach((e=>e.updateDisplay()));else mouse={x:e.offsetX*canvas.width/canvas.clientWidth,y:(canvas.clientHeight-e.offsetY)*canvas.height/canvas.clientHeight};onUniformUpdate()}})),timeElem.addEventListener("focusout",(()=>{0!=timeElem.innerText.length&&"."!=timeElem.innerText||(timeElem.innerText="0.00"),onUniformUpdate()})),timeElem.onkeypress=e=>{let t=String.fromCharCode(e.keyCode);window.getSelection().getRangeAt(0).startOffset;const n=timeElem.innerText.search(/\./);(!/[0-9]|\./.test(t)||"."==t&&n>=0)&&e.preventDefault()},timeElem.oninput=()=>{onUniformUpdate()},window.addEventListener("mousemove",(e=>{if(selectedElem===timeElem){let t=parseFloat(timeElem.innerText);t-=(e.movementY-e.movementX)/(e.shiftKey?10:100),timeElem.innerText=t.toFixed(3),onUniformUpdate()}return!0})),window.addEventListener("resize",(e=>{resizeCanvas()})),window.addEventListener("mouseup",(e=>{selectedElem=null,document.exitPointerLock()})),window.addEventListener("keydown",(e=>{if("Backquote"!=e.code||e.ctrlKey)if("Backquote"==e.code&&e.ctrlKey)"none"==commandElem.style.display?(commandElem.style.display="",commandElem.focus()):(commandElem.style.display="none",commandElem.value=""),e.preventDefault();else if("Digit1"==e.code&&(e.metaKey||e.ctrlKey))"none"==gui.domElement.style.display?gui.show():gui.hide(),e.preventDefault();else if("Digit2"==e.code&&(e.metaKey||e.ctrlKey))"none"==controls.style.display?controls.style.display="flex":controls.style.display="none",e.preventDefault();else if("Digit3"==e.code&&(e.metaKey||e.ctrlKey))"none"==texturesElem.style.display?texturesElem.style.display="flex":texturesElem.style.display="none",e.preventDefault();else if("Enter"==e.code&&(e.metaKey||e.altKey||e.ctrlKey))compilePromise=compile(),e.preventDefault();else if("KeyF"==e.code&&e.altKey)document.fullscreenElement?document.exitFullscreen():(codeElem.style.display="none",canvas.style.width="",canvas.style.height="",canvas.classList.add("floatingViewer"),document.documentElement.requestFullscreen()),e.preventDefault();else if("ArrowUp"==e.code&&e.altKey)animateController.setValue(!configGui.animate);else if("ArrowDown"==e.code&&e.altKey)timeElem.innerText="0.000",onUniformUpdate();else if("KeyE"==e.code&&(e.metaKey||e.ctrlKey)){e.preventDefault();const t=editor.getSelection(),n=inferVariableTypeAndValue(t);""!=n.type?extractUniform(n):gUniforms.has(t)&&insertUniform(t)}else if("KeyS"==e.code&&(e.metaKey||e.ctrlKey)){e.preventDefault(),configGui.quickSave();const t=new URLSearchParams;t.set("code",editor.getValue()),navigator.clipboard.writeText(`${getUrlWithoutParams()}?${t.toString()}`)}else"KeyO"==e.code&&(e.metaKey||e.ctrlKey)?(e.preventDefault(),configGui.quickLoad()):"KeyH"==e.code&&(e.ctrlKey||e.altKey)&&(dialogElement.showModal(),localStorage.setItem("help_shown",!0));else"none"==codeElem.style.display?(codeElem.style.display="flex",updateCodeEditorType()):codeElem.style.display="none",e.preventDefault()})),commandElem.addEventListener("keydown",(event=>{if("Enter"==event.code){let execStr=commandElem.value,guiVar=[...commandElem.value.matchAll(assignmentRegex)];if(1==guiVar.length&&gUniforms.has(guiVar[0][1])){const e=execStr.substr(guiVar[0][0].length);execStr=`interpolate('${guiVar[0][1]}', ${e});`,console.info(execStr)}try{let result=eval(execStr);SnackBar({status:"success",message:result,timeout:1e3})}catch(e){return void SnackBar({status:"error",message:e,timeout:3e3})}commandElem.style.display="none",commandElem.value=""}})),canvas.onwheel=e=>{mouse.z+=e.shiftKey?10*e.deltaY:2*e.deltaY,mouseControllers.forEach((e=>e.updateDisplay())),onUniformUpdate()},canvas.ondragover=e=>{e.preventDefault()},allTextures.forEach(((e,t)=>{e.ondragover=e=>e.preventDefault(),e.onclick=n=>{textures[t]&&(gl.deleteTexture(textures[t]),textures[t]=null),e.setAttribute("src",""),onUniformUpdate()},e.ondrop=n=>{n.stopPropagation(),n.preventDefault();const o=n.dataTransfer.getData("text/html");e.src=/src="?([^"\s]+)"?\s*/.exec(o)[1],e.onload=()=>{textures[t]&&(gl.deleteTexture(textures[t]),textures[t]=null),textures[t]=createTexture(e),onUniformUpdate()}}})),canvas.ondrop=e=>{if(e.preventDefault(),e.dataTransfer.items)for(var t=0;t<e.dataTransfer.items.length;t++)if("file"==e.dataTransfer.items[t].kind){var n=e.dataTransfer.items[t].getAsFile();createImageBitmap(n).then((e=>{}))}};</script></html>